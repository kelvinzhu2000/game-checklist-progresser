{% extends "base.html" %}

{% block title %}{{ game.name }} - Game Checklist Progresser{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ game.name }}</h1>
    <div class="game-context">
        <a href="{{ url_for('main.games') }}" class="btn btn-secondary">‚Üê Back to Games</a>
        {% if current_user.is_authenticated %}
            <a href="{{ url_for('checklist.create', game_id=game.id) }}" class="btn btn-success">Create New Checklist</a>
        {% endif %}
    </div>
</div>

{% if current_user.is_authenticated and (user_created or user_copied) %}
<section class="checklists-section">
    <h2>Your Checklists</h2>
    
    {% if user_created %}
    <div class="subsection">
        <h3>Created by You</h3>
        <div class="checklist-grid">
            {% for checklist in user_created %}
            <div class="checklist-card">
                <h4><a href="{{ url_for('checklist.view', checklist_id=checklist.id) }}">{{ checklist.title }}</a></h4>
                {% if checklist.description %}
                    <p class="description">{{ checklist.description[:100] }}{% if checklist.description|length > 100 %}...{% endif %}</p>
                {% endif %}
                <p class="item-count">{{ checklist.items.count() }} items</p>
                <p class="visibility">{% if checklist.is_public %}Public{% else %}Private{% endif %}</p>
                <div class="checklist-actions">
                    <a href="{{ url_for('checklist.view', checklist_id=checklist.id) }}" class="btn btn-primary">View</a>
                    <form method="POST" action="{{ url_for('checklist.delete', checklist_id=checklist.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this checklist?');">
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    {% if user_copied %}
    <div class="subsection">
        <h3>Tracking Progress</h3>
        <div class="checklist-grid">
            {% for user_checklist in user_copied %}
            {% set checklist = user_checklist.original_checklist %}
            <div class="checklist-card">
                <h4><a href="{{ url_for('checklist.view', checklist_id=checklist.id) }}">{{ checklist.title }}</a></h4>
                {% if checklist.description %}
                    <p class="description">{{ checklist.description[:100] }}{% if checklist.description|length > 100 %}...{% endif %}</p>
                {% endif %}
                <p class="creator">By {{ checklist.creator.username }}</p>
                <p class="item-count">{{ checklist.items.count() }} items</p>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ user_checklist.get_progress_percentage() }}%"></div>
                </div>
                <p class="progress-text">{{ user_checklist.get_progress_percentage() }}% complete</p>
                <div class="checklist-actions">
                    <a href="{{ url_for('checklist.view', checklist_id=checklist.id) }}" class="btn btn-primary">Continue</a>
                    <form method="POST" action="{{ url_for('checklist.delete_copy', checklist_id=checklist.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to remove this checklist from your account? Your progress will be lost.');">
                        <button type="submit" class="btn btn-danger">Remove</button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</section>
{% endif %}

<section class="checklists-section">
    <h2>Public Checklists</h2>
    
    {% if public_checklists %}
    <div class="checklist-grid">
        {% for checklist in public_checklists %}
        <div class="checklist-card">
            <h3><a href="{{ url_for('checklist.view', checklist_id=checklist.id) }}">{{ checklist.title }}</a></h3>
            {% if checklist.description %}
                <p class="description">{{ checklist.description[:100] }}{% if checklist.description|length > 100 %}...{% endif %}</p>
            {% endif %}
            <p class="creator">By {{ checklist.creator.username }}</p>
            <p class="item-count">{{ checklist.items.count() }} items</p>
            {% if current_user.is_authenticated %}
                <form method="POST" action="{{ url_for('checklist.copy', checklist_id=checklist.id) }}" style="margin-top: 0.5rem;">
                    <button type="submit" class="btn btn-success">Copy to My Checklists</button>
                </form>
            {% else %}
                <a href="{{ url_for('auth.login') }}" class="btn btn-secondary">Login to Copy</a>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p>No public checklists available for this game yet. {% if current_user.is_authenticated %}<a href="{{ url_for('checklist.create', game_id=game.id) }}">Be the first to create one!</a>{% endif %}</p>
    {% endif %}
</section>
{% endblock %}
