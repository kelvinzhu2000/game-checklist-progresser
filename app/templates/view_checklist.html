{% extends "base.html" %}

{% block title %}{{ checklist.title }} - Game Checklist Progresser{% endblock %}

{% block content %}
<div class="checklist-view">
    <div class="checklist-header">
        <h1>{{ checklist.title }}</h1>
        <p class="game-name">Game: {{ checklist.game.name }}</p>
        {% if checklist.description %}
            <p class="description">{{ checklist.description }}</p>
        {% endif %}
        <p class="meta">Created by {{ checklist.creator.username }} on {{ checklist.created_at.strftime('%Y-%m-%d') }}</p>
        
        {% if current_user.is_authenticated %}
            {% if checklist.creator_id == current_user.id %}
                <a href="{{ url_for('checklist.edit', checklist_id=checklist.id) }}" class="btn btn-primary">Edit Checklist</a>
                <a href="{{ url_for('checklist.add_item', checklist_id=checklist.id) }}" class="btn btn-primary">Add Item</a>
                <form method="POST" action="{{ url_for('checklist.delete', checklist_id=checklist.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this checklist? This will remove it for everyone who copied it.');">
                    <button type="submit" class="btn btn-danger">Delete Checklist</button>
                </form>
            {% endif %}
            {% if not user_copy %}
                <form method="POST" action="{{ url_for('checklist.copy', checklist_id=checklist.id) }}" style="display: inline;">
                    <button type="submit" class="btn btn-success">Copy to My Checklists</button>
                </form>
            {% else %}
                <form method="POST" action="{{ url_for('checklist.delete_copy', checklist_id=checklist.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to remove this checklist? Your progress will be lost.');">
                    <button type="submit" class="btn btn-warning">Remove from My Checklists</button>
                </form>
            {% endif %}
        {% endif %}
        
        {% if user_copy %}
            <div class="progress-info">
                <p>Your Progress: {{ user_copy.get_progress_percentage() }}%</p>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ user_copy.get_progress_percentage() }}%"></div>
                </div>
            </div>
        {% endif %}
    </div>
    
    {% if items %}
    <!-- Category Filter Legend -->
    <div id="category-legend" class="category-legend" style="display: none;">
        <h3>Filter by Category</h3>
        <div id="control-buttons" class="control-buttons"></div>
        <div id="category-filters" class="category-filters"></div>
    </div>
    
    <div class="checklist-items">
        <h2>Checklist Items</h2>
        <ul class="items-list">
            {% for item in items %}
            <li class="item {% if user_copy and progress.get(item.id) %}completed{% endif %}" data-category="{{ item.category or '' }}">
                <div class="item-content">
                    {% if user_copy %}
                        <form method="POST" action="{{ url_for('checklist.toggle_progress', checklist_id=checklist.id, item_id=item.id) }}" class="checkbox-form">
                            <input type="checkbox" {% if progress.get(item.id) %}checked{% endif %} onchange="this.form.submit()">
                        </form>
                    {% endif %}
                    <div class="item-details">
                        {% if item.category %}
                            <span class="item-category-badge">{{ item.category }}</span>
                        {% endif %}
                        <h3>{{ item.title }}</h3>
                        {% if item.description %}
                            <p>{{ item.description }}</p>
                        {% endif %}
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% else %}
        <p>No items in this checklist yet. {% if checklist.creator_id == current_user.id %}<a href="{{ url_for('checklist.add_item', checklist_id=checklist.id) }}">Add the first item!</a>{% endif %}</p>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get all unique categories from items
    const items = document.querySelectorAll('.item');
    const categories = new Set();
    let hasUncategorized = false;
    
    items.forEach(item => {
        const category = item.getAttribute('data-category');
        if (category && category.trim() !== '') {
            categories.add(category);
        } else {
            hasUncategorized = true;
        }
    });
    
    // Only show category legend if there are categories or uncategorized items
    if (categories.size > 0 || hasUncategorized) {
        const categoryLegend = document.getElementById('category-legend');
        const controlButtons = document.getElementById('control-buttons');
        const categoryFilters = document.getElementById('category-filters');
        categoryLegend.style.display = 'block';
        
        // Add "Select All" and "Deselect All" buttons to control buttons row
        const selectAllBtn = document.createElement('button');
        selectAllBtn.className = 'category-filter-btn control-btn';
        selectAllBtn.textContent = 'Select All';
        selectAllBtn.onclick = function() {
            selectAllCategories();
        };
        controlButtons.appendChild(selectAllBtn);
        
        const deselectAllBtn = document.createElement('button');
        deselectAllBtn.className = 'category-filter-btn control-btn';
        deselectAllBtn.textContent = 'Deselect All';
        deselectAllBtn.onclick = function() {
            deselectAllCategories();
        };
        controlButtons.appendChild(deselectAllBtn);
        
        // Create filter buttons for each category
        const sortedCategories = Array.from(categories).sort();
        sortedCategories.forEach(category => {
            const filterBtn = document.createElement('button');
            filterBtn.className = 'category-filter-btn active';
            filterBtn.textContent = category;
            filterBtn.setAttribute('data-category', category);
            filterBtn.onclick = function() {
                toggleCategoryFilter(this);
            };
            categoryFilters.appendChild(filterBtn);
        });
        
        // Add "Other" button for uncategorized items
        if (hasUncategorized) {
            const otherBtn = document.createElement('button');
            otherBtn.className = 'category-filter-btn active';
            otherBtn.textContent = 'Other';
            otherBtn.setAttribute('data-category', '');
            otherBtn.onclick = function() {
                toggleCategoryFilter(this);
            };
            categoryFilters.appendChild(otherBtn);
        }
    }
});

function toggleCategoryFilter(btn) {
    const category = btn.getAttribute('data-category');
    btn.classList.toggle('active');
    
    // Filter items
    const items = document.querySelectorAll('.item');
    items.forEach(item => {
        const itemCategory = item.getAttribute('data-category');
        if (itemCategory === category) {
            if (btn.classList.contains('active')) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        }
    });
}

function selectAllCategories() {
    const categoryBtns = document.querySelectorAll('.category-filter-btn:not(.control-btn)');
    const items = document.querySelectorAll('.item');
    
    categoryBtns.forEach(btn => btn.classList.add('active'));
    items.forEach(item => item.style.display = '');
}

function deselectAllCategories() {
    const categoryBtns = document.querySelectorAll('.category-filter-btn:not(.control-btn)');
    const items = document.querySelectorAll('.item');
    
    categoryBtns.forEach(btn => btn.classList.remove('active'));
    items.forEach(item => item.style.display = 'none');
}
</script>

<style>
.category-legend {
    margin: 1.5rem 0;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.category-legend h3 {
    margin: 0 0 0.75rem 0;
    font-size: 1.1rem;
    color: #333;
}

.control-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid #dee2e6;
}

.category-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.category-filter-btn {
    padding: 0.5rem 1rem;
    border: 2px solid #3498db;
    background: white;
    color: #3498db;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s;
}

.category-filter-btn:hover {
    background: #e3f2fd;
}

.category-filter-btn.active {
    background: #3498db;
    color: white;
}

.category-filter-btn.control-btn {
    border-color: #2c3e50;
    color: #2c3e50;
    background: #ecf0f1;
}

.category-filter-btn.control-btn:hover {
    background: #bdc3c7;
}

.item-category-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: #e3f2fd;
    color: #1976d2;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.item {
    transition: opacity 0.2s;
}
</style>
{% endblock %}
