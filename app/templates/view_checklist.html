{% extends "base.html" %}

{% block title %}{{ checklist.title }} - Game Checklist Progresser{% endblock %}

{% block content %}
<div class="checklist-view">
    <div class="checklist-header">
        <h1>{{ checklist.title }}</h1>
        <p class="game-name">Game: {{ checklist.game.name }}</p>
        {% if checklist.description %}
            <p class="description">{{ checklist.description }}</p>
        {% endif %}
        <p class="meta">Created by {{ checklist.creator.username }} on {{ checklist.created_at.strftime('%Y-%m-%d') }}</p>
        
        {% if current_user.is_authenticated %}
            {% if checklist.creator_id == current_user.id %}
                <a href="{{ url_for('checklist.edit', checklist_id=checklist.id) }}" class="btn btn-primary">Edit Checklist</a>
                <a href="{{ url_for('checklist.add_item', checklist_id=checklist.id) }}" class="btn btn-primary">Add Item</a>
                <form method="POST" action="{{ url_for('checklist.delete', checklist_id=checklist.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this checklist? This will remove it for everyone who copied it.');">
                    <button type="submit" class="btn btn-danger">Delete Checklist</button>
                </form>
            {% endif %}
            {% if not user_copy %}
                <form method="POST" action="{{ url_for('checklist.copy', checklist_id=checklist.id) }}" style="display: inline;">
                    <button type="submit" class="btn btn-success">Copy to My Checklists</button>
                </form>
            {% else %}
                <form method="POST" action="{{ url_for('checklist.delete_copy', checklist_id=checklist.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to remove this checklist? Your progress will be lost.');">
                    <button type="submit" class="btn btn-warning">Remove from My Checklists</button>
                </form>
            {% endif %}
        {% endif %}
        
        {% if user_copy %}
            <div class="progress-info">
                <p>Your Progress: {{ user_copy.get_progress_percentage() }}%</p>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ user_copy.get_progress_percentage() }}%"></div>
                </div>
            </div>
        {% endif %}
    </div>
    
    {% if items %}
    <!-- Reward Tally Section -->
    {% if user_copy %}
    <div id="reward-tally" class="reward-tally">
        <h3>Reward Tally</h3>
        <div class="tally-sections">
            <div class="tally-section">
                <h4>All Items</h4>
                <div id="total-rewards-all" class="tally-rewards"></div>
            </div>
            <div class="tally-section">
                <h4>Filtered Items</h4>
                <div id="total-rewards-filtered" class="tally-rewards"></div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Location Filter Legend (above category filter as requested) -->
    <div id="location-legend" class="location-legend" style="display: none;">
        <h3>Filter by Location</h3>
        <div id="location-control-buttons" class="control-buttons"></div>
        <div id="location-filters" class="location-filters"></div>
    </div>
    
    <!-- Category Filter Legend -->
    <div id="category-legend" class="category-legend" style="display: none;">
        <h3>Filter by Category</h3>
        <div id="control-buttons" class="control-buttons"></div>
        <div id="category-filters" class="category-filters"></div>
    </div>
    
    <!-- Reward Filter Legend -->
    <div id="reward-legend" class="reward-legend" style="display: none;">
        <h3>Filter by Reward</h3>
        <div id="reward-control-buttons" class="control-buttons"></div>
        <div id="reward-filters" class="reward-filters"></div>
    </div>
    
    <div class="checklist-items">
        <h2>Checklist Items</h2>
        <ul class="items-list">
            {% for item in items %}
            {% set reward_names = [] %}
            {% set reward_data = [] %}
            {% for item_reward in item.rewards %}
                {% set _ = reward_names.append(item_reward.reward.name) %}
                {% set _ = reward_data.append(item_reward.reward.name ~ ':' ~ item_reward.amount|string) %}
            {% endfor %}
            <li class="item {% if user_copy and progress.get(item.id) %}completed{% endif %} {% if user_copy and item_locked.get(item.id) %}locked{% endif %}" 
                data-location="{{ item.location or '' }}"
                data-category="{{ item.category or '' }}" 
                data-rewards="{{ ','.join(reward_names) }}"
                data-reward-details="{{ ','.join(reward_data) }}"
                data-completed="{{ 'true' if (user_copy and progress.get(item.id)) else 'false' }}"
                data-item-id="{{ item.id }}">
                <div class="item-content">
                    {% if user_copy %}
                        <input type="checkbox" 
                               class="item-checkbox" 
                               data-checklist-id="{{ checklist.id }}" 
                               data-item-id="{{ item.id }}" 
                               {% if progress.get(item.id) %}checked{% endif %}
                               {% if item_locked.get(item.id) %}disabled{% endif %}
                               onchange="toggleItemProgress(this)">
                    {% endif %}
                    <div class="item-details">
                        {% if item.location %}
                            <span class="item-location-badge">üìç {{ item.location }}</span>
                        {% endif %}
                        {% if item.category %}
                            <span class="item-category-badge">{{ item.category }}</span>
                        {% endif %}
                        {% if item.rewards|length > 0 %}
                            <div class="item-rewards-display">
                                {% for item_reward in item.rewards %}
                                    <span class="item-reward-badge">üèÜ {{ item_reward.amount }}x {{ item_reward.reward.name }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                        {% if item.prerequisites|length > 0 %}
                            <div class="item-prerequisites-display">
                                <span class="prerequisites-header">Prerequisites:</span>
                                {% for prereq in item.prerequisites %}
                                    {% if prereq.prerequisite_item_id %}
                                        <span class="item-prerequisite-badge {% if user_copy %}{% set prereq_progress = progress.get(prereq.prerequisite_item_id) %}{% if prereq_progress %}prereq-met{% else %}prereq-unmet{% endif %}{% endif %}">
                                            üìã {{ prereq.prerequisite_item.title }}
                                        </span>
                                    {% elif prereq.prerequisite_reward_id %}
                                        <span class="item-prerequisite-badge prereq-info">
                                            üèÜ {{ prereq.reward_amount or 1 }}x {{ prereq.prerequisite_reward.name }}{% if prereq.consumes_reward %} (consumes){% endif %}
                                        </span>
                                    {% elif prereq.freeform_text %}
                                        <span class="item-prerequisite-badge prereq-info">
                                            ‚úèÔ∏è {{ prereq.freeform_text }}
                                        </span>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <h3>{{ item.title }}</h3>
                        {% if item.description %}
                            <p>{{ item.description }}</p>
                        {% endif %}
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% else %}
        <p>No items in this checklist yet. {% if checklist.creator_id == current_user.id %}<a href="{{ url_for('checklist.add_item', checklist_id=checklist.id) }}">Add the first item!</a>{% endif %}</p>
    {% endif %}
</div>

<script>
// Toggle item progress via AJAX to avoid page reload
function toggleItemProgress(checkbox) {
    const checklistId = checkbox.getAttribute('data-checklist-id');
    const itemId = checkbox.getAttribute('data-item-id');
    const isChecked = checkbox.checked;
    
    // Find the parent list item
    const listItem = checkbox.closest('.item');
    
    // Send AJAX request
    fetch(`/checklist/${checklistId}/progress/${itemId}/toggle`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                // If request failed, revert checkbox state
                checkbox.checked = !isChecked;
                if (data.error === 'Prerequisites not met') {
                    alert('Cannot complete this item - prerequisites must be completed first!');
                } else {
                    alert('Failed to update progress. Please try again.');
                }
                throw new Error(data.error || 'Failed to update');
            });
        }
        return response.json();
    })
    .then(data => {
        if (data && data.success) {
            // Update the item's completed state
            listItem.setAttribute('data-completed', isChecked ? 'true' : 'false');
            
            // Update the completed class
            if (isChecked) {
                listItem.classList.add('completed');
            } else {
                listItem.classList.remove('completed');
            }
            
            // Update the reward tally
            updateRewardTally();
        }
    })
    .catch(error => {
        console.error('Error toggling progress:', error);
        // Revert checkbox state on error
        checkbox.checked = !isChecked;
        alert('Failed to update progress. Please try again.');
    });
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Get all unique locations from items
    const items = document.querySelectorAll('.item');
    const locations = new Set();
    let hasUnlocated = false;
    
    items.forEach(item => {
        const location = item.getAttribute('data-location');
        if (location && location.trim() !== '') {
            locations.add(location);
        } else {
            hasUnlocated = true;
        }
    });
    
    // Only show location legend if there are locations or unlocated items
    if (locations.size > 0 || hasUnlocated) {
        const locationLegend = document.getElementById('location-legend');
        const locationControlButtons = document.getElementById('location-control-buttons');
        const locationFilters = document.getElementById('location-filters');
        locationLegend.style.display = 'block';
        
        // Add "Select All" and "Deselect All" buttons to control buttons row
        const selectAllBtn = document.createElement('button');
        selectAllBtn.className = 'location-filter-btn control-btn';
        selectAllBtn.textContent = 'Select All';
        selectAllBtn.onclick = function() {
            selectAllLocations();
        };
        locationControlButtons.appendChild(selectAllBtn);
        
        const deselectAllBtn = document.createElement('button');
        deselectAllBtn.className = 'location-filter-btn control-btn';
        deselectAllBtn.textContent = 'Deselect All';
        deselectAllBtn.onclick = function() {
            deselectAllLocations();
        };
        locationControlButtons.appendChild(deselectAllBtn);
        
        // Create filter buttons for each location
        const sortedLocations = Array.from(locations).sort();
        sortedLocations.forEach(location => {
            const filterBtn = document.createElement('button');
            filterBtn.className = 'location-filter-btn active';
            filterBtn.textContent = location;
            filterBtn.setAttribute('data-location', location);
            filterBtn.onclick = function() {
                toggleLocationFilter(this);
            };
            locationFilters.appendChild(filterBtn);
        });
        
        // Add "Other" button for unlocated items
        if (hasUnlocated) {
            const otherBtn = document.createElement('button');
            otherBtn.className = 'location-filter-btn active';
            otherBtn.textContent = 'Other';
            otherBtn.setAttribute('data-location', '');
            otherBtn.onclick = function() {
                toggleLocationFilter(this);
            };
            locationFilters.appendChild(otherBtn);
        }
    }
    
    // Get all unique categories from items
    const categories = new Set();
    let hasUncategorized = false;
    
    items.forEach(item => {
        const category = item.getAttribute('data-category');
        if (category && category.trim() !== '') {
            categories.add(category);
        } else {
            hasUncategorized = true;
        }
    });
    
    // Only show category legend if there are categories or uncategorized items
    if (categories.size > 0 || hasUncategorized) {
        const categoryLegend = document.getElementById('category-legend');
        const controlButtons = document.getElementById('control-buttons');
        const categoryFilters = document.getElementById('category-filters');
        categoryLegend.style.display = 'block';
        
        // Add "Select All" and "Deselect All" buttons to control buttons row
        const selectAllBtn = document.createElement('button');
        selectAllBtn.className = 'category-filter-btn control-btn';
        selectAllBtn.textContent = 'Select All';
        selectAllBtn.onclick = function() {
            selectAllCategories();
        };
        controlButtons.appendChild(selectAllBtn);
        
        const deselectAllBtn = document.createElement('button');
        deselectAllBtn.className = 'category-filter-btn control-btn';
        deselectAllBtn.textContent = 'Deselect All';
        deselectAllBtn.onclick = function() {
            deselectAllCategories();
        };
        controlButtons.appendChild(deselectAllBtn);
        
        // Create filter buttons for each category
        const sortedCategories = Array.from(categories).sort();
        sortedCategories.forEach(category => {
            const filterBtn = document.createElement('button');
            filterBtn.className = 'category-filter-btn active';
            filterBtn.textContent = category;
            filterBtn.setAttribute('data-category', category);
            filterBtn.onclick = function() {
                toggleCategoryFilter(this);
            };
            categoryFilters.appendChild(filterBtn);
        });
        
        // Add "Other" button for uncategorized items
        if (hasUncategorized) {
            const otherBtn = document.createElement('button');
            otherBtn.className = 'category-filter-btn active';
            otherBtn.textContent = 'Other';
            otherBtn.setAttribute('data-category', '');
            otherBtn.onclick = function() {
                toggleCategoryFilter(this);
            };
            categoryFilters.appendChild(otherBtn);
        }
    }
    
    // Get all unique rewards from items
    const rewards = new Set();
    let hasItemsWithoutRewards = false;
    
    items.forEach(item => {
        const rewardsAttr = item.getAttribute('data-rewards');
        if (rewardsAttr && rewardsAttr.trim() !== '') {
            const itemRewards = rewardsAttr.split(',').map(r => r.trim()).filter(r => r);
            itemRewards.forEach(reward => rewards.add(reward));
        } else {
            hasItemsWithoutRewards = true;
        }
    });
    
    // Only show reward legend if there are rewards
    if (rewards.size > 0 || hasItemsWithoutRewards) {
        const rewardLegend = document.getElementById('reward-legend');
        const rewardControlButtons = document.getElementById('reward-control-buttons');
        const rewardFilters = document.getElementById('reward-filters');
        rewardLegend.style.display = 'block';
        
        // Add "Select All" and "Deselect All" buttons
        const selectAllRewardsBtn = document.createElement('button');
        selectAllRewardsBtn.className = 'reward-filter-btn control-btn';
        selectAllRewardsBtn.textContent = 'Select All';
        selectAllRewardsBtn.onclick = function() {
            selectAllRewards();
        };
        rewardControlButtons.appendChild(selectAllRewardsBtn);
        
        const deselectAllRewardsBtn = document.createElement('button');
        deselectAllRewardsBtn.className = 'reward-filter-btn control-btn';
        deselectAllRewardsBtn.textContent = 'Deselect All';
        deselectAllRewardsBtn.onclick = function() {
            deselectAllRewards();
        };
        rewardControlButtons.appendChild(deselectAllRewardsBtn);
        
        // Create filter buttons for each reward
        const sortedRewards = Array.from(rewards).sort();
        sortedRewards.forEach(reward => {
            const filterBtn = document.createElement('button');
            filterBtn.className = 'reward-filter-btn active';
            filterBtn.textContent = 'üèÜ ' + reward;
            filterBtn.setAttribute('data-reward', reward);
            filterBtn.onclick = function() {
                toggleRewardFilter(this);
            };
            rewardFilters.appendChild(filterBtn);
        });
        
        // Add "Other" button for items without rewards
        if (hasItemsWithoutRewards) {
            const otherBtn = document.createElement('button');
            otherBtn.className = 'reward-filter-btn active';
            otherBtn.textContent = 'No Rewards';
            otherBtn.setAttribute('data-reward', '');
            otherBtn.onclick = function() {
                toggleRewardFilter(this);
            };
            rewardFilters.appendChild(otherBtn);
        }
    }
    
    // Initialize reward tally
    updateRewardTally();
});

function toggleLocationFilter(btn) {
    const location = btn.getAttribute('data-location');
    btn.classList.toggle('active');
    applyFilters();
}

function selectAllLocations() {
    const locationBtns = document.querySelectorAll('.location-filter-btn:not(.control-btn)');
    locationBtns.forEach(btn => btn.classList.add('active'));
    applyFilters();
}

function deselectAllLocations() {
    const locationBtns = document.querySelectorAll('.location-filter-btn:not(.control-btn)');
    locationBtns.forEach(btn => btn.classList.remove('active'));
    applyFilters();
}

function toggleCategoryFilter(btn) {
    const category = btn.getAttribute('data-category');
    btn.classList.toggle('active');
    applyFilters();
}

function selectAllCategories() {
    const categoryBtns = document.querySelectorAll('.category-filter-btn:not(.control-btn)');
    categoryBtns.forEach(btn => btn.classList.add('active'));
    applyFilters();
}

function deselectAllCategories() {
    const categoryBtns = document.querySelectorAll('.category-filter-btn:not(.control-btn)');
    categoryBtns.forEach(btn => btn.classList.remove('active'));
    applyFilters();
}

function toggleRewardFilter(btn) {
    const reward = btn.getAttribute('data-reward');
    btn.classList.toggle('active');
    applyFilters();
}

function selectAllRewards() {
    const rewardBtns = document.querySelectorAll('.reward-filter-btn:not(.control-btn)');
    rewardBtns.forEach(btn => btn.classList.add('active'));
    applyFilters();
}

function deselectAllRewards() {
    const rewardBtns = document.querySelectorAll('.reward-filter-btn:not(.control-btn)');
    rewardBtns.forEach(btn => btn.classList.remove('active'));
    applyFilters();
}

function applyFilters() {
    const items = document.querySelectorAll('.item');
    const activeLocationBtns = document.querySelectorAll('.location-filter-btn.active:not(.control-btn)');
    const activeCategoryBtns = document.querySelectorAll('.category-filter-btn.active:not(.control-btn)');
    const activeRewardBtns = document.querySelectorAll('.reward-filter-btn.active:not(.control-btn)');
    
    // Get active locations
    const activeLocations = new Set();
    activeLocationBtns.forEach(btn => {
        activeLocations.add(btn.getAttribute('data-location'));
    });
    
    // Get active categories
    const activeCategories = new Set();
    activeCategoryBtns.forEach(btn => {
        activeCategories.add(btn.getAttribute('data-category'));
    });
    
    // Get active rewards
    const activeRewards = new Set();
    activeRewardBtns.forEach(btn => {
        activeRewards.add(btn.getAttribute('data-reward'));
    });
    
    // If no filters are active, hide all items
    const hasActiveLocationFilters = activeLocationBtns.length > 0;
    const hasActiveCategoryFilters = activeCategoryBtns.length > 0;
    const hasActiveRewardFilters = activeRewardBtns.length > 0;
    
    items.forEach(item => {
        const itemLocation = item.getAttribute('data-location');
        const itemCategory = item.getAttribute('data-category');
        const itemRewardsAttr = item.getAttribute('data-rewards');
        const itemRewards = itemRewardsAttr ? itemRewardsAttr.split(',').map(r => r.trim()).filter(r => r) : [];
        
        let showByLocation = true;
        let showByCategory = true;
        let showByReward = true;
        
        // Check location filter
        if (hasActiveLocationFilters) {
            showByLocation = activeLocations.has(itemLocation);
        }
        
        // Check category filter
        if (hasActiveCategoryFilters) {
            showByCategory = activeCategories.has(itemCategory);
        }
        
        // Check reward filter
        if (hasActiveRewardFilters) {
            if (itemRewards.length === 0) {
                // Item has no rewards, check if "No Rewards" filter is active
                showByReward = activeRewards.has('');
            } else {
                // Item has rewards, check if any match active filters
                showByReward = itemRewards.some(reward => activeRewards.has(reward));
            }
        }
        
        // Show item only if it passes all filters
        if (showByLocation && showByCategory && showByReward) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });
    
    // Update reward tally after filtering
    updateRewardTally();
}

function calculateRewardTotals(items) {
    const totals = {};
    
    items.forEach(item => {
        const isCompleted = item.getAttribute('data-completed') === 'true';
        const rewardDetails = item.getAttribute('data-reward-details');
        
        if (rewardDetails && rewardDetails.trim() !== '') {
            const rewards = rewardDetails.split(',');
            rewards.forEach(rewardStr => {
                const [rewardName, amountStr] = rewardStr.split(':');
                const amount = parseInt(amountStr) || 0;
                
                if (!totals[rewardName]) {
                    totals[rewardName] = { total: 0, collected: 0 };
                }
                
                totals[rewardName].total += amount;
                if (isCompleted) {
                    totals[rewardName].collected += amount;
                }
            });
        }
    });
    
    return totals;
}

function updateRewardTally() {
    const rewardTally = document.getElementById('reward-tally');
    if (!rewardTally) return; // Not on a user's checklist
    
    const allItems = document.querySelectorAll('.item');
    const visibleItems = Array.from(allItems).filter(item => item.style.display !== 'none');
    
    // Calculate totals for all items
    const allTotals = calculateRewardTotals(allItems);
    
    // Calculate totals for filtered items
    const filteredTotals = calculateRewardTotals(visibleItems);
    
    // Display all items totals
    const allRewardsDiv = document.getElementById('total-rewards-all');
    allRewardsDiv.innerHTML = '';
    const allRewardNames = Object.keys(allTotals).sort();
    if (allRewardNames.length === 0) {
        allRewardsDiv.innerHTML = '<p class="no-rewards">No rewards in this checklist</p>';
    } else {
        allRewardNames.forEach(rewardName => {
            const data = allTotals[rewardName];
            const rewardItem = document.createElement('div');
            rewardItem.className = 'tally-item';
            rewardItem.innerHTML = `
                <span class="tally-reward-name">üèÜ ${rewardName}</span>
                <span class="tally-count">${data.collected} / ${data.total}</span>
            `;
            allRewardsDiv.appendChild(rewardItem);
        });
    }
    
    // Display filtered items totals
    const filteredRewardsDiv = document.getElementById('total-rewards-filtered');
    filteredRewardsDiv.innerHTML = '';
    const filteredRewardNames = Object.keys(filteredTotals).sort();
    if (filteredRewardNames.length === 0) {
        filteredRewardsDiv.innerHTML = '<p class="no-rewards">No rewards in filtered items</p>';
    } else {
        filteredRewardNames.forEach(rewardName => {
            const data = filteredTotals[rewardName];
            const rewardItem = document.createElement('div');
            rewardItem.className = 'tally-item';
            rewardItem.innerHTML = `
                <span class="tally-reward-name">üèÜ ${rewardName}</span>
                <span class="tally-count">${data.collected} / ${data.total}</span>
            `;
            filteredRewardsDiv.appendChild(rewardItem);
        });
    }
}
</script>

<style>
.location-legend {
    margin: 1.5rem 0;
    padding: 1rem;
    background: #f0f8f0;
    border-radius: 8px;
    border: 1px solid #a8d5a8;
}

.location-legend h3 {
    margin: 0 0 0.75rem 0;
    font-size: 1.1rem;
    color: #333;
}

.location-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.location-filter-btn {
    padding: 0.5rem 1rem;
    border: 2px solid #27ae60;
    background: white;
    color: #27ae60;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s;
}

.location-filter-btn:hover {
    background: #d4edda;
}

.location-filter-btn.active {
    background: #27ae60;
    color: white;
}

.location-filter-btn.control-btn {
    border-color: #2c3e50;
    color: #2c3e50;
    background: #ecf0f1;
}

.location-filter-btn.control-btn:hover {
    background: #bdc3c7;
}

.item-location-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: #d4edda;
    color: #155724;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
    margin-right: 0.5rem;
}

.category-legend {
    margin: 1.5rem 0;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.category-legend h3 {
    margin: 0 0 0.75rem 0;
    font-size: 1.1rem;
    color: #333;
}

.control-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid #dee2e6;
}

.category-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.category-filter-btn {
    padding: 0.5rem 1rem;
    border: 2px solid #3498db;
    background: white;
    color: #3498db;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s;
}

.category-filter-btn:hover {
    background: #e3f2fd;
}

.category-filter-btn.active {
    background: #3498db;
    color: white;
}

.category-filter-btn.control-btn {
    border-color: #2c3e50;
    color: #2c3e50;
    background: #ecf0f1;
}

.category-filter-btn.control-btn:hover {
    background: #bdc3c7;
}

.item-category-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: #e3f2fd;
    color: #1976d2;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.item-rewards-display {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.item-reward-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: #fff3cd;
    color: #856404;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 500;
    border: 1px solid #ffc107;
}

.reward-legend {
    margin: 1.5rem 0;
    padding: 1rem;
    background: #fffbf0;
    border-radius: 8px;
    border: 1px solid #ffe4a3;
}

.reward-legend h3 {
    margin: 0 0 0.75rem 0;
    font-size: 1.1rem;
    color: #333;
}

.reward-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.reward-filter-btn {
    padding: 0.5rem 1rem;
    border: 2px solid #ffc107;
    background: white;
    color: #856404;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s;
}

.reward-filter-btn:hover {
    background: #fff3cd;
}

.reward-filter-btn.active {
    background: #ffc107;
    color: #212529;
}

.reward-filter-btn.control-btn {
    border-color: #2c3e50;
    color: #2c3e50;
    background: #ecf0f1;
}

.reward-filter-btn.control-btn:hover {
    background: #bdc3c7;
}

.item {
    transition: opacity 0.2s;
}

/* Reward Tally Styles */
.reward-tally {
    margin: 1.5rem 0;
    padding: 1.5rem;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    border-radius: 12px;
    border: 2px solid #a0aec0;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.reward-tally h3 {
    margin: 0 0 1rem 0;
    font-size: 1.3rem;
    color: #2c3e50;
    text-align: center;
    font-weight: 600;
}

.tally-sections {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}

@media (max-width: 768px) {
    .tally-sections {
        grid-template-columns: 1fr;
    }
}

.tally-section {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.tally-section h4 {
    margin: 0 0 0.75rem 0;
    font-size: 1rem;
    color: #34495e;
    font-weight: 600;
    border-bottom: 2px solid #e0e0e0;
    padding-bottom: 0.5rem;
}

.tally-rewards {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.tally-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0.75rem;
    background: #f8f9fa;
    border-radius: 6px;
    border-left: 4px solid #ffc107;
}

.tally-reward-name {
    font-size: 0.9rem;
    font-weight: 500;
    color: #495057;
}

.tally-count {
    font-size: 0.95rem;
    font-weight: 600;
    color: #28a745;
    background: #d4edda;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
}

.no-rewards {
    color: #6c757d;
    font-style: italic;
    text-align: center;
    padding: 1rem;
    margin: 0;
}

/* Prerequisite display styles */
.item-prerequisites-display {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    align-items: center;
}

.prerequisites-header {
    font-size: 0.85rem;
    font-weight: 600;
    color: #555;
}

.item-prerequisite-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: #e8d7f1;
    color: #5e2a84;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 500;
    border: 1px solid #9b59b6;
}

.item-prerequisite-badge.prereq-met {
    background: #d4edda;
    color: #155724;
    border-color: #28a745;
}

.item-prerequisite-badge.prereq-unmet {
    background: #f8d7da;
    color: #721c24;
    border-color: #dc3545;
}

.item-prerequisite-badge.prereq-info {
    background: #fff3cd;
    color: #856404;
    border-color: #ffc107;
}

/* Locked item styles */
.item.locked {
    opacity: 0.6;
    background: #f5f5f5;
}

.item.locked .item-checkbox {
    cursor: not-allowed;
}

.item.locked h3 {
    color: #999;
}

.item.locked::before {
    content: "üîí";
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 1.2rem;
}

.item {
    position: relative;
}

</style>
{% endblock %}
